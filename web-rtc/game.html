<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>P2P WebRTC DataChannel</title>
	<script src="https://cdn.jsdelivr.net/gh/davidshimjs/qrcodejs/qrcode.min.js"></script>
	<style>
		/* General Reset */
		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
		}

		body {
			font-family: Arial, sans-serif;
			display: flex;
			justify-content: center;
			align-items: center;
			min-height: 100vh;
			background-color: #f4f4f9;
			flex-direction: column;
			text-align: center;
			color: #333;
		}

		h1 {
			margin-bottom: 20px;
			font-size: 2rem;
			color: #333;
			text-transform: uppercase;
			letter-spacing: 2px;
		}

		/* QR Code Styling */
		#qrcode {
			margin-bottom: 30px;
			padding: 20px;
			background-color: #fff;
			border-radius: 12px;
			box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
		}

		/* Canvas Styling */
		canvas {
			border: 2px solid #333;
			background-color: #ffffff;
			border-radius: 8px;
			box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
		}

		/* Info text styling */
		.info {
			margin-top: 20px;
			font-size: 1rem;
			color: #555;
		}

		.info span {
			font-weight: bold;
			color: #007bff;
		}
	</style>
</head>

<body>
	<h2>WebRTC P2P Chat</h2>

	<div id="qrcode"></div>
	<div class="info">
		<p>Scan the QR code above to join the game.</p>
	</div>
	<div id="peers">

	</div>

	<script>
		const url = `http://${window.location.hostname}:8080`
		const qrcode = new QRCode(document.getElementById('qrcode'), {
			text: url,
			width: 128,
			height: 128,
			colorDark: '#000',
			colorLight: '#fff',
			correctLevel: QRCode.CorrectLevel.H
		});
		const ws = new WebSocket("ws://10.5.6.176:8081");
		console.log('Connected to WebSocket Signaller')

		const peers = new Map();

		const peersContainer = document.getElementById('peers');

		function updatePeersUI() {
			peersContainer.innerHTML = '';
			peers.forEach((peer, id) => {
				console.log(id)
				const peerDiv = document.createElement('div');
				peerDiv.textContent = `Peer ID: ${id}`;
				peerDiv.classList.add('peer-item');
				peersContainer.appendChild(peerDiv);
			});
		}

		function makeConnection() {
			const connection = new RTCPeerConnection({
				iceServers: [] // No external STUN/TURN needed in pure LAN
			});
			connection.onicecandidate = (event) => {
				if (event.candidate) {
					ws.send(JSON.stringify({iceCandidate: event.candidate}));
				}
			};
			connection.ondatachannel = (event) => {
				const receivedChannel = event.channel;

				receivedChannel.onmessage = (event) => {
					console.log("Received:", event.data);
				}
			};
			const dataChannel = connection.createDataChannel("chat", {
				ordered: false,
				reliable: false
			});
			dataChannel.onopen = () => {
				console.log("Data channel open");
				updatePeersUI();
			}
			dataChannel.onclose = () => console.log("Data channel is CLOSED!");
			dataChannel.onerror = (error) => console.log("Data channel ERROR:", error);
			return {
				connection: connection, dataChannel: dataChannel
			}
		}

		ws.onmessage = async (event) => {
			const message = JSON.parse(event.data);
			const ip = message.offer.ip
			if (message.offer) {
				let peer = makeConnection();
				peers.set(ip, peer);
				// peers[ip] = peer;
				await peer.connection.setRemoteDescription(new RTCSessionDescription(message.offer));
				const answer = await peer.connection.createAnswer();
				await peer.connection.setLocalDescription(answer);
				ws.send(JSON.stringify({answer}));
			}
			else if (message.iceCandidate) {
				await peers[ip].connection.addIceCandidate(new RTCIceCandidate(message.iceCandidate));
			}
		};

		function sendMessage() {
			peers.forEach((peer, ip) => {
				if (peer.dataChannel.readyState === "open") {
					peer.dataChannel.send("message");
				}
			});
		}

		async function startConnection() {
			const offer = await peerConnection.createOffer();
			await peerConnection.setLocalDescription(offer);
			ws.send(JSON.stringify({offer}));
		}
	</script>
</body>

</html>
