<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>P2P WebRTC DataChannel</title>
</head>

<body>
	<h2>WebRTC P2P Chat</h2>
	<button onclick="sendMessage()">send</button>
	<button onclick="startConnection()">connect</button>

	<script>
		// this variable is probably a bad hack but it works if they join one at a time
		let setOffer = false;
		const ws = new WebSocket("ws://10.5.6.176:8081"); // Replace with LAN IP
		console.log('Connected to WebSocket Signaller')

		const peerConnection = new RTCPeerConnection({
			iceServers: [] // No external STUN/TURN needed in pure LAN
		});

		ws.onmessage = async (event) => {
			const message = JSON.parse(event.data);

			if (message.offer) {
				console.log("recieved offer")
				await peerConnection.setRemoteDescription(new RTCSessionDescription(message.offer));
				const answer = await peerConnection.createAnswer();
				await peerConnection.setLocalDescription(answer);
				ws.send(JSON.stringify({answer}));
			}
			else if (message.answer && setOffer) {
				console.log("recieved answer")
				if (peerConnection.connectionState == "connected") {
					console.log("blocking answer")
					return;
				}
				await peerConnection.setRemoteDescription(new RTCSessionDescription(message.answer));
				ws.close();
			}
			else if (message.iceCandidate && setOffer) {
				console.log("ice")
				if (peerConnection.connectionState == "connected") {
					console.log("blocking ice")
					return;
				}
				await peerConnection.addIceCandidate(new RTCIceCandidate(message.iceCandidate));
			}
		};

		peerConnection.onicecandidate = (event) => {
			if (event.candidate) {
				ws.send(JSON.stringify({iceCandidate: event.candidate}));
			}
		};

		peerConnection.ondatachannel = (event) => {
			const receivedChannel = event.channel;
			receivedChannel.onmessage = (event) => {
				console.log("Received:", event.data);
			}
		};

		const dataChannel = peerConnection.createDataChannel("chat", {
			ordered: false,
			reliable: false
		});

		dataChannel.onopen = () => {
		}
		dataChannel.onclose = () => console.log("Data channel is CLOSED!");
		dataChannel.onerror = (error) => console.log("Data channel ERROR:", error);

		function sendMessage() {
			if (dataChannel.readyState === "open") {
				dataChannel.send("message");
			}

		}

		async function startConnection() {
			const offer = await peerConnection.createOffer();
			offer.ip = "something";
			console.log(offer)
			await peerConnection.setLocalDescription(offer);
			setOffer = true;
			ws.send(JSON.stringify({offer}));
		}
	</script>
</body>

</html>
