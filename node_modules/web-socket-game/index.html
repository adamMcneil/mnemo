<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Top Down Platformer</title>
</head>

<body>
	<script>

		const socket = new WebSocket('ws://localhost:8001');
		console.log('Created socket');

		const controllerStates = new Map();
		const playerPositions = new Map();

		class Player {
			constructor(name) {
				this.name = name;
				this.color = "blue";
				this.x = 200;
				this.y = 150;
			}

			getRandomColor() {
				const letters = '0123456789ABCDEF';
				let color = '#';
				for (let i = 0; i < 6; i++) {
					color += letters[Math.floor(Math.random() * 16)];
				}
				return color;
			}
		}

		socket.onmessage = function (event) {
			console.log(event.data);
			const messageObject = JSON.parse(event.data);
			const name = messageObject.name;
			if (!playerPositions.has(name)) {
				playerPositions.set(name, new Player(name));
			}
			controllerStates.set(name, messageObject);
		};

		const canvas = document.createElement("canvas");
		const ctx = canvas.getContext("2d");
		document.body.appendChild(canvas);
		canvas.width = 400;
		canvas.height = 300;

		function update() {
			for (const [id, player] of playerPositions) {
				player.x += controllerStates.get(id).x;
				player.y += controllerStates.get(id).y;

				// Keep player within canvas bounds
				if (player.x < 0) player.x = 0;
				if (player.x + player.width > canvas.width) player.x = canvas.width - player.width;
				if (player.y < 0) player.y = 0;
				if (player.y + player.height > canvas.height) player.y = canvas.height - player.height;
			}
		}

		function draw() {
			ctx.clearRect(0, 0, canvas.width, canvas.height);
			for (const [id, player] of playerPositions) {
				ctx.fillStyle = player.color;
				ctx.fillRect(player.x, player.y, 10, 10);
			}
		}

		function loop() {

			update();
			draw();
			requestAnimationFrame(loop);
		}

		loop();
	</script>
</body>

</html>
